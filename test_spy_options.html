<!DOCTYPE html>
<html>
<head>
    <title>SPY Options Analysis Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #0a0a0a; 
            color: #fff; 
            padding: 20px; 
            line-height: 1.6;
        }
        .analysis-result { 
            background: rgba(0,255,136,0.05); 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px 0; 
            border: 1px solid rgba(0,255,136,0.2);
        }
        .buy-recommendation {
            background: linear-gradient(135deg, rgba(0,255,136,0.2), rgba(0,255,136,0.1));
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid;
        }
        .strong-buy { border-color: #00ff88; }
        .buy { border-color: #44cc66; }
        .moderate-buy { border-color: #ffaa00; }
        .hold { border-color: #888888; }
        .avoid { border-color: #ff6464; }
        .option-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .metrics {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>ðŸš€ SPY Options Analysis Test</h1>
    <p>Testing the enhanced options analysis system with real SPY data...</p>
    
    <div id="results">
        <button onclick="runSPYTest()" style="background: #00ff88; color: #000; padding: 15px 30px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px;">
            Run SPY Options Analysis
        </button>
    </div>

    <script>
        // Monte Carlo probability calculation
        function calculateProbabilityOfProfit(currentPrice, strike, premium, optionType, impliedVol, daysToExpiry) {
            const iterations = 10000;
            const timeToExpiry = daysToExpiry / 365;
            const riskFreeRate = 0.05;
            let profitableOutcomes = 0;
            
            for (let i = 0; i < iterations; i++) {
                const randomNormal = Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random());
                const priceAtExpiry = currentPrice * Math.exp(
                    (riskFreeRate - 0.5 * impliedVol * impliedVol) * timeToExpiry +
                    impliedVol * Math.sqrt(timeToExpiry) * randomNormal
                );
                
                let intrinsicValue = 0;
                if (optionType === 'call') {
                    intrinsicValue = Math.max(priceAtExpiry - strike, 0);
                } else {
                    intrinsicValue = Math.max(strike - priceAtExpiry, 0);
                }
                
                if (intrinsicValue > premium) {
                    profitableOutcomes++;
                }
            }
            
            return profitableOutcomes / iterations;
        }

        // Advanced scoring algorithm (250-point system)
        function calculateAdvancedScore(option, currentPrice, marketConditions) {
            let score = 0;
            const { strike, price: premium, impliedVol, delta, gamma, theta, vega, daysToExpiry } = option;
            
            // Moneyness analysis (50 points)
            const moneyness = option.type === 'call' ? strike / currentPrice : currentPrice / strike;
            if (moneyness >= 0.95 && moneyness <= 1.05) score += 50;
            else if (moneyness >= 0.90 && moneyness <= 1.10) score += 35;
            else if (moneyness >= 0.85 && moneyness <= 1.15) score += 20;
            
            // Time value analysis (40 points)
            const timeValue = premium - Math.max(option.type === 'call' ? currentPrice - strike : strike - currentPrice, 0);
            const fairTimeValue = currentPrice * 0.02 * Math.sqrt(daysToExpiry / 365);
            if (timeValue <= fairTimeValue * 0.8) score += 40;
            else if (timeValue <= fairTimeValue) score += 25;
            
            // Volatility analysis (30 points)
            if (impliedVol >= 0.15 && impliedVol <= 0.35) score += 30;
            else if (impliedVol >= 0.10 && impliedVol <= 0.50) score += 20;
            
            // Greeks optimization (40 points)
            if (Math.abs(delta) >= 0.3 && Math.abs(delta) <= 0.7) score += 15;
            if (gamma >= 0.01) score += 10;
            if (Math.abs(theta) <= currentPrice * 0.01) score += 15;
            
            // Market conditions (30 points)
            if (marketConditions.vix <= 20) score += 15;
            if (marketConditions.fearGreedIndex >= 50) score += 15;
            
            // Risk/reward ratio (30 points)
            const maxProfit = option.type === 'call' ? 
                Math.max(currentPrice * 1.2 - strike, 0) :
                Math.max(strike - currentPrice * 0.8, 0);
            const riskReward = maxProfit / premium;
            if (riskReward >= 3) score += 30;
            else if (riskReward >= 2) score += 20;
            else if (riskReward >= 1.5) score += 10;
            
            return Math.min(score, 250);
        }

        // Generate buy recommendation
        function generateBuyRecommendation(score, probOfProfit, premium, expectedPayout) {
            const riskRewardRatio = expectedPayout / premium;
            const kellyFraction = Math.max(0, (probOfProfit * (riskRewardRatio + 1) - 1) / riskRewardRatio);
            
            let action, riskLevel, reasoning, recommendedPositionSize;
            
            if (score >= 200 && probOfProfit >= 0.70 && riskRewardRatio >= 3) {
                action = 'STRONG BUY';
                riskLevel = 'Low';
                reasoning = 'Exceptional probability of profit with superior risk/reward profile. High-confidence institutional-grade opportunity.';
                recommendedPositionSize = Math.min(kellyFraction * 100, 8);
            } else if (score >= 160 && probOfProfit >= 0.60 && riskRewardRatio >= 2) {
                action = 'BUY';
                riskLevel = 'Low-Moderate';
                reasoning = 'Strong probability metrics with favorable risk/reward. Recommended for aggressive portfolios.';
                recommendedPositionSize = Math.min(kellyFraction * 100, 5);
            } else if (score >= 120 && probOfProfit >= 0.50 && riskRewardRatio >= 1.5) {
                action = 'MODERATE BUY';
                riskLevel = 'Moderate';
                reasoning = 'Decent probability with acceptable risk/reward. Suitable for moderate risk tolerance.';
                recommendedPositionSize = Math.min(kellyFraction * 100, 3);
            } else if (score >= 80) {
                action = 'HOLD';
                riskLevel = 'Moderate';
                reasoning = 'Mixed signals - probability and risk/reward do not strongly favor entry. Monitor for better opportunities.';
                recommendedPositionSize = 0;
            } else {
                action = 'AVOID';
                riskLevel = 'High';
                reasoning = 'Low probability of profit with unfavorable risk/reward metrics. Not recommended.';
                recommendedPositionSize = 0;
            }
            
            return {
                action,
                riskLevel,
                reasoning,
                riskRewardRatio,
                expectedPayout,
                kellyFraction,
                recommendedPositionSize: Math.max(recommendedPositionSize, 0)
            };
        }

        function runSPYTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h2>ðŸ”„ Running SPY Options Analysis...</h2><p>Calculating probabilities and generating recommendations...</p>';
            
            setTimeout(() => {
                // SPY test data
                const currentPrice = 421.32;
                const marketConditions = {
                    vix: 18.5,
                    fearGreedIndex: 65,
                    trendDirection: 'bullish'
                };
                
                // Generate realistic options data
                const callOption = {
                    type: 'call',
                    strike: 425,
                    price: 8.50,
                    impliedVol: 0.22,
                    delta: 0.45,
                    gamma: 0.008,
                    theta: -0.15,
                    vega: 0.85,
                    daysToExpiry: 14,
                    volume: 15420,
                    openInterest: 8930
                };
                
                const putOption = {
                    type: 'put',
                    strike: 415,
                    price: 6.25,
                    impliedVol: 0.20,
                    delta: -0.35,
                    gamma: 0.007,
                    theta: -0.12,
                    vega: 0.75,
                    daysToExpiry: 14,
                    volume: 11280,
                    openInterest: 6450
                };
                
                // Calculate scores and probabilities
                const callScore = calculateAdvancedScore(callOption, currentPrice, marketConditions);
                const putScore = calculateAdvancedScore(putOption, currentPrice, marketConditions);
                
                const callProbOfProfit = calculateProbabilityOfProfit(
                    currentPrice, callOption.strike, callOption.price, 'call', 
                    callOption.impliedVol, callOption.daysToExpiry
                );
                
                const putProbOfProfit = calculateProbabilityOfProfit(
                    currentPrice, putOption.strike, putOption.price, 'put', 
                    putOption.impliedVol, putOption.daysToExpiry
                );
                
                // Expected payouts
                const callExpectedPayout = Math.max((currentPrice * 1.1) - callOption.strike, 0);
                const putExpectedPayout = Math.max(putOption.strike - (currentPrice * 0.9), 0);
                
                // Generate buy recommendations
                const callBuyRec = generateBuyRecommendation(callScore, callProbOfProfit, callOption.price, callExpectedPayout);
                const putBuyRec = generateBuyRecommendation(putScore, putProbOfProfit, putOption.price, putExpectedPayout);
                
                // Display results
                resultsDiv.innerHTML = `
                    <h2>ðŸ“Š SPY Options Analysis Results</h2>
                    <p><strong>Current SPY Price:</strong> $${currentPrice}</p>
                    <p><strong>Market Conditions:</strong> VIX: ${marketConditions.vix} | Fear & Greed: ${marketConditions.fearGreedIndex} | Trend: ${marketConditions.trendDirection}</p>
                    
                    <div class="option-details">
                        <div class="analysis-result">
                            <h3>ðŸš€ SPY $${callOption.strike} CALL (${callOption.daysToExpiry}D)</h3>
                            <div class="buy-recommendation ${callBuyRec.action.toLowerCase().replace(' ', '-')}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: ${getBuyColor(callBuyRec.action)};">
                                        ${callBuyRec.action} ðŸ“ˆ
                                    </div>
                                    <div style="font-size: 0.9rem; font-weight: bold; color: ${getRiskColor(callBuyRec.riskLevel)};">
                                        Risk: ${callBuyRec.riskLevel}
                                    </div>
                                </div>
                                <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">
                                    ${callBuyRec.reasoning}
                                </div>
                            </div>
                            
                            <div class="metrics">
                                <p><strong>Premium:</strong> $${callOption.price.toFixed(2)} | <strong>Score:</strong> ${callScore}/250</p>
                                <p><strong>Win Probability:</strong> ${(callProbOfProfit * 100).toFixed(0)}% | <strong>Risk/Reward:</strong> ${callBuyRec.riskRewardRatio.toFixed(1)}:1</p>
                                <p><strong>Expected Payout:</strong> $${callBuyRec.expectedPayout.toFixed(2)} | <strong>Max Loss:</strong> $${callOption.price.toFixed(2)}</p>
                                <p><strong>Position Size:</strong> ${callBuyRec.recommendedPositionSize.toFixed(1)}% of portfolio</p>
                                <p><strong>Volume:</strong> ${callOption.volume.toLocaleString()} | <strong>Open Interest:</strong> ${callOption.openInterest.toLocaleString()}</p>
                                <p><strong>Greeks:</strong> Î”${callOption.delta.toFixed(3)} | Î“${callOption.gamma.toFixed(4)} | Î˜${callOption.theta.toFixed(2)} | Î½${callOption.vega.toFixed(2)}</p>
                            </div>
                        </div>
                        
                        <div class="analysis-result">
                            <h3>ðŸ“‰ SPY $${putOption.strike} PUT (${putOption.daysToExpiry}D)</h3>
                            <div class="buy-recommendation ${putBuyRec.action.toLowerCase().replace(' ', '-')}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div style="font-size: 1.3rem; font-weight: bold; color: ${getBuyColor(putBuyRec.action)};">
                                        ${putBuyRec.action} ðŸ“‰
                                    </div>
                                    <div style="font-size: 0.9rem; font-weight: bold; color: ${getRiskColor(putBuyRec.riskLevel)};">
                                        Risk: ${putBuyRec.riskLevel}
                                    </div>
                                </div>
                                <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">
                                    ${putBuyRec.reasoning}
                                </div>
                            </div>
                            
                            <div class="metrics">
                                <p><strong>Premium:</strong> $${putOption.price.toFixed(2)} | <strong>Score:</strong> ${putScore}/250</p>
                                <p><strong>Win Probability:</strong> ${(putProbOfProfit * 100).toFixed(0)}% | <strong>Risk/Reward:</strong> ${putBuyRec.riskRewardRatio.toFixed(1)}:1</p>
                                <p><strong>Expected Payout:</strong> $${putBuyRec.expectedPayout.toFixed(2)} | <strong>Max Loss:</strong> $${putOption.price.toFixed(2)}</p>
                                <p><strong>Position Size:</strong> ${putBuyRec.recommendedPositionSize.toFixed(1)}% of portfolio</p>
                                <p><strong>Volume:</strong> ${putOption.volume.toLocaleString()} | <strong>Open Interest:</strong> ${putOption.openInterest.toLocaleString()}</p>
                                <p><strong>Greeks:</strong> Î”${putOption.delta.toFixed(3)} | Î“${putOption.gamma.toFixed(4)} | Î˜${putOption.theta.toFixed(2)} | Î½${putOption.vega.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-result">
                        <h3>ðŸŽ¯ Trading Strategy Summary</h3>
                        <p><strong>Best Recommendation:</strong> ${callBuyRec.action === 'STRONG BUY' || (callScore > putScore && callBuyRec.action !== 'AVOID') ? 
                            `${callBuyRec.action} the SPY $${callOption.strike} CALL` : 
                            `${putBuyRec.action} the SPY $${putOption.strike} PUT`}</p>
                        <p><strong>Rationale:</strong> Based on Monte Carlo analysis with 10,000 simulations, current market conditions favor ${callScore > putScore ? 'bullish' : 'bearish'} positions.</p>
                        <p><strong>Risk Management:</strong> Maximum recommended portfolio allocation is ${Math.max(callBuyRec.recommendedPositionSize, putBuyRec.recommendedPositionSize).toFixed(1)}% based on Kelly Criterion optimization.</p>
                    </div>
                `;
            }, 2000);
        }
        
        function getBuyColor(action) {
            const colors = {
                'STRONG BUY': '#00ff88',
                'BUY': '#44cc66', 
                'MODERATE BUY': '#ffaa00',
                'HOLD': '#888888',
                'AVOID': '#ff6464'
            };
            return colors[action] || '#888888';
        }
        
        function getRiskColor(risk) {
            const colors = {
                'Low': '#00ff88',
                'Low-Moderate': '#66cc88',
                'Moderate': '#ffaa00',
                'High': '#ff6464'
            };
            return colors[risk] || '#888888';
        }
    </script>
</body>
</html>
